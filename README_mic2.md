
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

Ответ:
Перед определением решения реализации API Gateway следует уточнить - на какой инфраструктуре работает компания. Если это облачные решения и сервера - 
то логично использовать облачные API, в идеале от той же компании, что предоставляет облачную инфраструктуру. Например, Yandex API Gateway
Сервис для создания API-шлюзов, поддерживающий спецификацию OpenAPI 3.0 и набор расширений для интеграции с другими облачными сервисами. Или другой облачный API, 
которые зачастую поддерживают интеграцию сторонних облаков.

Рассмотрим возможные решения, котороя компания может установить локально

| Kong Gateway     | Kong — это Lua‑приложение, которое крутится на nginx. И основной инструмент его расширения поэтому - Lua плагины. Хоть и есть варианты написания плагинов на Go, JS, Python, но у них есть особенности имплементации, которые приводят к потере производительности                                                                             |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                  | Некоторые из функций, предлагаемых Kong:                                                                                                                                                                                                                                                                                                       |
|                  | ·        Аутентификация                                                                                                                                                                                                                                                                                                                        |
|                  | ·        Управление трафиком                                                                                                                                                                                                                                                                                                                   |
|                  | ·        Аналитика                                                                                                                                                                                                                                                                                                                             |
|                  | ·        Преобразования                                                                                                                                                                                                                                                                                                                        |
|                  | ·        Ведение журнала                                                                                                                                                                                                                                                                                                                       |
|                  | ·        Бессерверный                                                                                                                                                                                                                                                                                                                          |
|                  | ·        Расширяемый с использованием архитектуры плагинов                                                                                                                                                                                                                                                                                     |
|                  | Kong получил очень хорошую документацию и интеграцию .                                                                                                                                                                                                                                                                                         |
| Apache APISIX    | Первоначально Apache e APISIX был создан на основе китайской технологии ZhiLiu, а на более позднем этапе он вошел в инкубатор Apache и стал открытым исходным кодом.                                                                                                                                                                           |
|                  | Apache APISIX основан на Nginx и etcd, имеет динамическую маршрутизацию и горячую загрузку плагинов, что особенно подходит для управления API в системе микросервисов.                                                                                                                                                                         |
| KrakenD          | Написан на go                                                                                                                                                                                                                                                                                                                                  |
|                  | Открытые исходники                                                                                                                                                                                                                                                                                                                             |
|                  | Самый быстрый в сравнении с Tyk и Kong                                                                                                                                                                                                                                                                                                         |
|                  | Бесплатная Community Version                                                                                                                                                                                                                                                                                                                   |
|                  | В бесплатной версии отстутствуют определенные плагины, также сама система обладает определенными особенностями работы, которые могут не устроить пользователя. Но, все проблемы можно решить написанием собственных плагинов                                                                                                                   |
|                  | Хорошая документация                                                                                                                                                                                                                                                                                                                           |
| Tyk              | Написан на go                                                                                                                                                                                                                                                                                                                                  |
|                  | Открытые исходники                                                                                                                                                                                                                                                                                                                             |
|                  | Бесплатная Community Version                                                                                                                                                                                                                                                                                                                   |
|                  | Недостаток официальной конфигурации                                                                                                                                                                                                                                                                                                            |
|                  | Ниже приведены некоторые из готовых функций, предлагаемых TYK.                                                                                                                                                                                                                                                                                 |
|                  | ·        Аутентификация                                                                                                                                                                                                                                                                                                                        |
|                  | ·        Квоты и ограничение скорости                                                                                                                                                                                                                                                                                                          |
|                  | ·        Контроль версий                                                                                                                                                                                                                                                                                                                       |
|                  | ·        Уведомления и события                                                                                                                                                                                                                                                                                                                 |
|                  | ·        Макет API                                                                                                                                                                                                                                                                                                                             |
|                  | ·        Детальный мониторинг и аналитика                                                                                                                                                                                                                                                                                                      |
|                  | TYK также доступен на торговой площадке AWS . Хороший выбор, если ваш стек приложений находится на AWS.                                                                                                                                                                                                                                        |
| Ocelot           | это технология шлюза API с открытым исходным кодом, реализованная с помощью технологии .NET Core. В его функции входят: маршрутизация, агрегирование запросов, обнаружение сервисов, аутентификация, аутентификация, предохранитель с ограничением тока и встроенная интеграция балансировщика нагрузки                                        |
|                  | Ocelot предлагает стандартные функции, такие как маршрутизация, аутентификация, ограничение скорости, кэширование, балансировка нагрузки и многое другое. Он не поддерживает фрагментированное кодирование, пересылку заголовка хоста и Swagger.                                                                                               |
|                  | Ocelot действует как промежуточное ПО в определенном порядке. Он манипулирует объектом HttpRequest, переводя его в состояние, указанное в его конфигурации, до тех пор, пока он не достигнет промежуточного программного обеспечения построителя запросов                                                                                      |
| Goku API Gateway | Это шлюз микросервисов на основе Golang, который обеспечивает высокопроизводительную динамическую маршрутизацию, оркестрацию сервисов, управление несколькими арендаторами, контроль доступа к API и т. д.                                                                                                                                     |
|                  | Goku предоставляет графический интерфейс и систему подключаемых модулей для упрощения настройки и расширения. Помимо стандартных функций, Goku предлагает кластеризацию, горячие обновления, оповещения, ведение журнала и т. д.                                                                                                               |
| Express Gateway  | Express Gateway построен на Express.js . Express Gateway — это набор компонентов, декларативно созданных на основе Express для соответствия сценарию использования API Gateway. Мощь Express Gateway использует богатую экосистему промежуточного программного обеспечения Express.                                                            |
| Gloo             | полнофункциональный шлюз API нового поколения и Ingress Controller для облачных сред. Он построен на основе Envoy Proxy для подключения, защиты и управления трафиком через службы приложений.                                                                                                                                                 |
|                  | Gloo поддерживает подключение к широкому спектру рабочих нагрузок для обеспечения безопасности и управления ими, а также отличается исключительной маршрутизацией на функциональном уровне. Он доступен как с открытым исходным кодом, так и для предприятий. Корпоративная версия предлагает следующее:                                       |
|                  | ·        Портал разработчиков                                                                                                                                                                                                                                                                                                                  |
|                  | ·        ВАФ                                                                                                                                                                                                                                                                                                                                   |
|                  | ·        Предотвращение потери данных                                                                                                                                                                                                                                                                                                          |
|                  | ·        Еще один способ аутентификации                                                                                                                                                                                                                                                                                                        |
|                  | ·        Расширенное ограничение скорости и управление несколькими кластерами                                                                                                                                                                                                                                                                  |
| Fusio            | это система управления API, поскольку она помогает разрабатывать фактические конечные точки API (т. е. запрашивать и преобразовывать данные из базы данных). Это не ограничивается прокси-запросами к другому API. Он предоставляет простой и интуитивно понятный серверный интерфейс для контроля и управления вашим API.                     |
|                  | Некоторые из функций, предлагаемых Fusio:                                                                                                                                                                                                                                                                                                      |
|                  | ·        Монетизация                                                                                                                                                                                                                                                                                                                           |
|                  | ·        Поддержка подписки                                                                                                                                                                                                                                                                                                                    |
|                  | ·        Создать спецификацию схемы OAI, RAML                                                                                                                                                                                                                                                                                                  |
|                  | ·        Документация                                                                                                                                                                                                                                                                                                                          |
|                  | и другие стандартные функции шлюза API.                                                                                                                                                                                                                                                                                                        |
| WSO2             | решение для управления API с полным жизненным циклом, которое можно запускать где угодно. Он может быть развернут локально, в облаке или гибридным способом, когда его компоненты могут быть распределены и развернуты в нескольких облачных и локальных инфраструктурах.                                                                      |
|                  | Он включает в себя облачный шлюз API и предоставляет оператору Kubernetes возможность легко преобразовывать необработанные микросервисы в управляемые API. API Manager интегрируется с сервисными сетками и предоставляет полноценную плоскость управления и плоскость контроля для управления, мониторинга и монетизации API и продуктов API. |
|                  | Он поддерживает публикацию API, управление жизненным циклом, разработку приложений, контроль доступа, ограничение скорости и аналитику в одной полностью интегрированной системе.                                                                                                                                                              |

Очень важным моментом при выборе API Gateway в связи со сложившейся ситуацией вокруг санкций является то, это должен быть open-source проект, как минимум в своей базовой части. Проекты с закрытым кодом, и требующие лицензионного ключа с ограниченным сроком действия, по известным причинам опасны для использования или попросту недоступны в России.

Следующим важным моментом в выборе API Gateway для компании - это то, на основе чего пишется или возможно написаны микросервисы компании. Логично выбирать шлюз написанный на том же языке программирования, что и микросервисы.

В какчестве решения для компании я бы предложил KrakenD - как наиболее задокументированный проект с открытым кодом, который легко можно настроить под конечного пользователя дописав собственные плагины.

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

Ответ:   

| Kafka       | Kafka не обладает многообразием конфигураций, сложных механизмов распределения сообщений по очередям и процесса доставки каждого отдельного сообщения. Ядро его функциональности — запись данных, хранение их в течение заданного времени и выдача этих данных по запросу. Все остальные особенности можно рассматривать как следствие этого концепта. И в этом его преимущество перед другими opensource-решениями, которые работают по пуш-механизму или протоколу AMQP.В Kafka данные физически хранятся на диске в виде партиций. Новые сообщения добавляются в commit log. Они помещаются строго в конец, и их порядок после этого не меняется, благодаря чему в каждой отдельной партиции сообщения всегда расположены в порядке их добавления. В Kafka используется pull-, а не push-механизм. В RabbitMQ сообщения загружаются в читателей, а в Kafka они приходят сами и берут, что нужно. Процесс чтения сообщений аналогичен проходу по массиву. |
|-------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| RabbitMQ    | Брокер сообщений, основанный на протоколе AMQP, Advanced Message Queuing Protocol. Это открытый протокол передачи сообщений, который нужен для общения разных частей системы между собой. Система состоит из нескольких компонентов:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|             | ·        AMQP-брокер маршрутизирует сообщения и помогает частям системы общаться между собой;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|             | ·        Producer (отправитель) отправляет сообщения в брокер;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|             | ·        Consumer (читатель) получает эти сообщения;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|             | ·        Exchange (обменник) получает сообщения и распределяет их между очередями;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|             | ·        Queue (очередь) хранит сообщения и отдаёт их подписанным получателям;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|             | ·        Binding хранит правила для обменника.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|             | У RabbitMQ есть библиотеки клиента для большинства современных языков и открытый исходный код, чтобы в нём разбираться. У RabbitMQ удобная админка, где можно в режиме реального времени разбираться с тем, что происходит. Роутинги можно настраивать в процессе, переключая нагрузку и меняя правила обработки. Многие параметры можно менять, чтобы подстроить систему под свои нужды. Особенно это касается очередей. При этом у RabbitMQ есть сложности при горизонтальном масштабировании в кластере. Приходится добавлять настройки кластеризации над очередями, а они сложные и работают плохо. Приходится выбирать, чем пожертвовать — гибкостью или скоростью.                                                                                                                                                                                                                                                                                    |
| AWS SNS/SQS | Это управляемый сервис очередей сообщений, с помощью которого можно так же, как и с помощью других брокеров, изолировать и масштабировать микросервисы и бессерверные приложения. SQS предлагает два типа очередей сообщений:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|             | ·        Стандартные очереди обеспечивают максимальную пропускную способность и доставку сообщений по принципу «хотя бы один раз». Стандартная очередь старается соблюдать порядок сообщений, но он может быть нарушен. Если система требует сохранения порядка, то лучше использовать очередь FIFO.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|             | ·        Очереди FIFO с ограниченной пропускной способностью гарантируют, что сообщения будут обрабатываться строго однократно и исключительно в порядке отправления. Они предназначены для улучшения обмена сообщениями между приложениями, когда порядок операций и событий имеет решающее значение или когда дублирование недопустимо.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|             | SQS работает в связке с SNS — сервисом обмена сообщениями для связи между приложениями, а также между приложениями и пользователями. Обмен происходит по модели pub-sub («издатель — подписчик»). Данный брокер очень зависим от экосистемы AWS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Memphis     | Брокер сообщений с открытым исходным кодом, специально созданный разработчиками для использования в сценариях использования потоковой передачи в приложениях. Его можно легко развернуть и масштабировать. Этот брокер сообщений использует функциональные возможности ядра NATS, предлагая методы автоматической оптимизации, управление схемой, встроенную обработку и возможности устранения неполадок. Ключевые особенности Мемфиса:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|             | ·        Работает в Kubernetes для поддержки полной аппаратной абстракции для масштабирования, обновления, перезагрузки и многого другого.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|             | ·        Устранить неполадки с неиспользованными сообщениями легко, если получить доступ к пути передачи данных каждого сообщения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|             | ·        Интуитивно понятный пользовательский интерфейс и интерфейс командной строки удобны для инженеров по обработке данных для устранения ошибок в режиме реального времени.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|             | ·        Содержит уникальное управление схемой и встроенные возможности преобразования.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ZeroMQ      | ZeroMQ, сложный брокер сообщений, который предлагает высокоскоростные соединения между приложениями независимо от языка и платформы, на которой они работают. Он состоит из механизмов асинхронного ввода-вывода, загруженных в библиотеки обмена сообщениями, и устанавливает отношения «многие ко многим» между отправителем и получателем. Он передает сообщения от одного приложения к другому через веб-сокеты с помощью многочисленных транспортных каналов, таких как внутрипроцессные, межпроцессные, TCP, многоадресная рассылка, TIPC, IPC и UDP.                                                                                                                                                                                                                                                                                                                                                                                                 |
|             | ZeroMQ оснащен всеми функциями, присутствующими в стандартной распределенной системе обмена сообщениями, и отправляет сообщения через подключаемые сокеты, которые могут быть организованы по различным шаблонам, таким как публикация-подписка, запрос-ответ, распределение задач и разветвление.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|             | ZeroMQ обеспечивает высокую степень настройки для удовлетворения уникальных требований различных вариантов использования и поддерживает несколько шаблонов обмена сообщениями и языковых реализаций.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |


В качестве брокера сообщений, исходя из требований проекта, следует выбрать RabbitMQ. Так как Kafka не отвечает требованием поддержка различных форматов сообщений, разделение прав доступа к различным потокам сообщений. Остальные брокеры более сложны и зачастую заточены под определенные среды разработки (AWS, Kubernetes) и не так часто встречаются в использовании, что влияет на масштабность информационного комьюнити

